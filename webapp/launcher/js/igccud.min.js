window.IG$||(window.IG$={}),IG$._wcollab_data={msg_template:{cls:"kiwi-messagelist-item",items:[{cls:"kiwi-messagelist-message kiwi-messagelist-message--modern kiwi-messagelist-message--authorfirst kiwi-messagelist-message-notice",items:[{cls:"kiwi-messagelist-modern-left"},{cls:"kiwi-messagelist-modern-right",items:[{items:[{cls:"kiwi-messagelist-top",items:[{cls:"kiwi-messagelist-nick",items:[{cls:"kiwi-messagelist-nick-prefix",type:"span",innerHtml:"{actor.nick}"}]},{cls:"kiwi-messagelist-time"}]},{cls:"kiwi-messagelist-body",innerHtml:"{message}"}]}]}]}]},workspace_template:{cls:"kiwi-workspace",items:[{cls:"kiwi-container kiwi-container--sidebar-open",items:[{cls:"kiwi-header kiwi-theme-bg",items:[{cls:"kiwi-header-name"},{cls:"kiwi-header-options"}]},{cls:"kiwi-container-content",id:"messagecontainer",items:[{cls:"kiwi-messagelist",id:"messagelist"}]}]},{cls:"kiwi-controlinput kiwi-theme-bg",items:[{cls:"kiwi-controlinput-selfuser"},{cls:"kiwi-controlinput-inner",items:[{cls:"kiwi-controlinput-form",type:"form",items:[{cls:"kiwi-typinguserslist"},{cls:"kiwi-controlinput-input-wrap",items:[{cls:"kiwi-ircinput kiwi-controlinput-input",items:[{cls:"kiwi-ircinput-editor",id:"ircinput",attr:{placeholder:"Send a message...",contenteditable:"true",role:"textbox",spellcheck:"true"}}]}]},{cls:"kiwi-controlinput-send fa fa-paper-plane",type:"button",id:"btn_send"}]}]}]}]},welcome_template:{cls:"kiwi-wrap kiwi-theme-bg",items:[{cls:"kiwi-startup-common kiwi-welcome-simple kiwi-welcome-simple--recaptcha",items:[{cls:"kiwi-startup-common-section kiwi-startup-common-section-connection",items:[{cls:"u-form u-form--big kiwi-welcome-simple-form",type:"form",items:[{type:"h2"},{cls:"u-input-text",items:[{type:"label",attr:{for:"txt_nick"},innerHtml:"{nick}"},{cls:"u-input-text-inputs",items:[{type:"input",id:"txt_nick",cls:"u-input"}]}]},{type:"button",cls:"u-button u-button-primary u-submit kiwi-welcome-simple-start",innerHtml:"{start}",handler:function(e){e.preventDefault(),e.stopPropagation();this._connect_channel()}},{items:[{cls:"fn-sponsor",innerHtml:"{sponsor}"}]}]}]},{cls:"kiwi-startup-common-section kiwi-startup-common-section-info",items:[{cls:"kiwi-startup-common-section-info-content",innerHtml:"{startup}"}]}]}]}},IG$._wcollab=function(e){this._settings=e||{}},IG$._wcollab.prototype={_init:function(){var e,t=this,i=window.location.href.split("/");(e=t._settings).protocol||(e.protocol="https:"==i[0]?"wss":"ws"),e.url||(e.url=i[2]),e.ws_path=e.ws_path||"/websocket/collaborate";var n,s=e.protocol+"://"+e.url+e.ws_path;t._userdetail=e.userdetail;try{(n=t.__ws=new WebSocket(s)).onopen=function(e){t.onopen(e)},n.onmessage=function(e){t.onmessage(e)},n.onclosed=function(e){t.onclosed(e)},n.onclosing=function(e){t.onclosing(e)}}catch(e){}},onopen:function(e){this._send_ws("_call_","login",{})},onmessage:function(e){var t=JSON.parse(e.data),i={};if("_irc_"==t.application){switch(t.action){case"login":t.content.name,t.content.id,t.content.email;break;case"writecontent":t.content.nodepath,t.content.username;break;case"message":$("#main_loading").fadeOut(),i=t.content,t.content.message}this._appendMsg(i)}},_appendMsg:function(e){var t,i,n=this,s=($("#messagecontainer"),$("#messagelist")),a=n.theight||0;t=$("<div></div>").appendTo(s),i=n.draw_area(t,IG$._wcollab_data.msg_template,e),e.actor&&e.actor.self&&i.addClass("igc_self_msg"),n.theight=a+=i.height(),s.animate({scrollTop:a},"slow");var o=$("a",t);$.each(o,function(e,t){var i=$(t);i.bind("click",function(e){e.preventDefault(),e.stopPropagation();var t=i.attr("amp_reply");t&&n._send_ws("_call_","message",{message:t,actor:{nick:"me",self:!0}})})})},closeSession:function(){var e=this.__ws;e&&e.close(),this.__ws=null},_send_ws:function(e,t,i){var n=this,s=n.__ws,a=n._channel_info,o={application:e,action:t,instance:a.instance,channel:a.channel,id:n.guid(),content:i};switch(s.send(JSON.stringify(o)),t){case"message":n._appendMsg(i)}},load_app:function(){var e=this,t=e._settings.html;e.rootdiv=t,e.rootdiv.empty(),e._pages={},e._load_page("welcome_template")},_load_page:function(i){var e,t=this,n=t._settings;$.each(t._pages,function(e,t){e==i?t.region.show():t.region.hide()}),t._pages[i]||(e=t.draw_area(t.rootdiv,IG$._wcollab_data[i],n.message),t._pages[i]={pname:i,region:e})},draw_area:function(e,t,i){return this._draw_sub(e,t,i)},setLoading:function(e){$("#loading")[e?"show":"fadeOut"]()},showErrorMessage:function(e,t){var i=$("#popup_error");msg_title=$("#msg_title",i),msg_content=$("#msg_content",i),msg_title.html(e),msg_content.html(t),i.fadeIn()},_send_ajax:function(e,a){var o=this,t=o._settings;e.uniquekey=o._get_uniquekey(),window.Pace&&window.Pace.start(),o.setLoading(!0),$.ajax({url:t.request_url,data:JSON.stringify(e),dataType:"json",type:"POST",async:!0,contentType:"application/json; charset=UTF-8",timeout:6e5,beforeSend:function(e,t){},cache:!1,crossDomain:!1,processData:!0,success:function(e,t,i){window.Pace&&window.Pace.stop();var n=(e=e||{errorcode:"0xffff",errormsg:"Server incorrect responding"}).errorcode;if(o.setLoading(!1),null!=n&&0<n.length){var s=!0;a&&(s=a.func.apply(a.scope||o,[e,!0])),!1!==s&&o.showErrorMessage("Error!",e.errormsg)}else a&&a.func.apply(a.scope||o,[e,!1])},error:function(e,t,i){window.Pace&&window.Pace.stop(),o.setLoading(!1);o.showErrorMessage("Error!","Server URL Connection Failed")}})},_get_uniquekey:function(){var e=new Date;return""+e.getFullYear()+(1+e.getMonth())+e.getDate()+e.getHours()+e.getMinutes()+e.getSeconds()},_draw_sub:function(e,t,i){var n,s,a,o=this,c=t.type||"div",r=["<"+c];if(t.cls&&r.push(" class='"+t.cls+"'"),t.name&&r.push(" name='"+t.name+"'"),t.id&&r.push(" id='"+t.id+"'"),t.attr&&$.each(t.attr,function(e,t){r.push(" "+e+"='"+t+"'")}),r.push("></"+c+">"),r=$(r.join("")).appendTo(e),t.handler&&r.bind("click",function(e){t.handler.apply(t.scope||o,[e])}),t.items)$.each(t.items,function(e,t){o._draw_sub(r,t,i)});else if(t.innerHtml)if(i&&"{"==t.innerHtml.charAt(0)&&"}"==t.innerHtml.charAt(t.innerHtml.length-1))if(-1<(n=t.innerHtml.substring(1,t.innerHtml.length-1)).indexOf(".")){for(n=n.split("."),s=i,a=0;a<n.length;a++){if(!s[n[a]]){s=null;break}s=s[n[a]]}r.append(s||"")}else r.append(i[n]||"");else r.append(t.innerHtml);return r},_connect_channel:function(){var i=this,e=$("#txt_nick");if(!e.val())return e.addClass("required_field"),void i.showErrorMessage("Field Input","Nick name is required!");e.removeClass("required_field"),$("#main_loading").show(),i._send_ajax({ack:"collaborate",payload:{cmd:"request_channel"},mbody:i._settings.channel_name?{channel_name:"#"+i._settings.channel_name,nick:e.val()}:{nick:e.val()},_mts_:i._settings._mts_},{func:function(e,t){t||(i._channel_info=e.result,i._load_page("workspace_template"),i._init_ws(),i._init())}})},_init_ws:function(){var t=this,e=t._pages.workspace_template;$("#ircinput",e.region).keydown(function(e){13==e.which&&(e.preventDefault(),e.stopPropagation(),t._send_msg())}),$("#btn_send",e.region).bind("click",function(e){e.preventDefault(),e.stopPropagation(),t._send_msg()})},_send_msg:function(){var e=this._pages.workspace_template,t=$("#ircinput",e.region),i=t.html();i&&(t.empty(),this._send_ws("_call_","message",{message:i,actor:{nick:"me",self:!0}}))},guid:function(){var e,t;if(IG$._guid_lut)e=IG$._guid_lut;else for(e=IG$._guid_lut=[],t=0;t<256;t++)e[t]=(t<16?"0":"")+t.toString(16);var i=4294967295*Math.random()|0,n=4294967295*Math.random()|0,s=4294967295*Math.random()|0,a=4294967295*Math.random()|0;return e[255&i]+e[i>>8&255]+e[i>>16&255]+e[i>>24&255]+"-"+e[255&n]+e[n>>8&255]+"-"+e[n>>16&15|64]+e[n>>24&255]+"-"+e[63&s|128]+e[s>>8&255]+"-"+e[s>>16&255]+e[s>>24&255]+e[255&a]+e[a>>8&255]+e[a>>16&255]+e[a>>24&255]}},$(document).ready(function(){var e=$("#popup_error");$("#btn_close",e).bind("click",function(){e.fadeOut()})});