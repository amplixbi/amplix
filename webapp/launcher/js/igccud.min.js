window.IG$||(window.IG$={}),IG$._wcollab_data={msg_template:{cls:"kiwi-messagelist-item",items:[{cls:"kiwi-messagelist-message kiwi-messagelist-message--modern kiwi-messagelist-message--authorfirst kiwi-messagelist-message-notice",items:[{cls:"kiwi-messagelist-modern-left",id:"avatar"},{cls:"kiwi-messagelist-modern-right",items:[{items:[{cls:"kiwi-messagelist-top",items:[{cls:"kiwi-messagelist-nick",items:[{cls:"kiwi-messagelist-nick-prefix",type:"span",innerHtml:"{actor.nick}"}]},{cls:"kiwi-messagelist-time"}]},{cls:"kiwi-messagelist-body",innerHtml:"{message}"}]}]},{cls:"kiwi-messagelist-modern-right-pad"}]}]},workspace_template:{cls:"kiwi-workspace",items:[{cls:"kiwi-container kiwi-container--sidebar-open",items:[{cls:"kiwi-header kiwi-theme-bg",items:[{cls:"kiwi-header-name"},{cls:"kiwi-header-options"}]},{cls:"kiwi-container-content",id:"messagecontainer",items:[{cls:"kiwi-messagelist",id:"messagelist",items:[{cls:"kiwi-messagelist-inner",id:"messagelist-inner"}]}]}]},{cls:"kiwi-controlinput kiwi-theme-bg",items:[{cls:"kiwi-controlinput-selfuser"},{cls:"kiwi-controlinput-inner",items:[{cls:"kiwi-controlinput-form",type:"form",items:[{cls:"kiwi-typinguserslist"},{cls:"kiwi-controlinput-input-wrap",items:[{cls:"kiwi-ircinput kiwi-controlinput-input",items:[{cls:"kiwi-ircinput-editor",id:"ircinput",attr:{placeholder:"Send a message...",contenteditable:"true",role:"textbox",spellcheck:"true"}}]}]},{cls:"kiwi-controlinput-send fa fa-paper-plane",type:"button",id:"btn_send"}]}]}]}]},welcome_template:{cls:"kiwi-wrap kiwi-theme-bg",items:[{cls:"kiwi-startup-common kiwi-welcome-simple kiwi-welcome-simple--recaptcha",items:[{cls:"kiwi-startup-common-section kiwi-startup-common-section-connection",items:[{cls:"u-form u-form--big kiwi-welcome-simple-form",type:"form",items:[{type:"h2"},{cls:"u-input-text",id:"robo_form1",items:[{type:"label",attr:{for:"txt_nick"},innerHtml:"{nick}"},{cls:"u-input-text-inputs",items:[{type:"input",id:"txt_nick",cls:"u-input"}]}]},{type:"button",id:"robo_form2",cls:"u-button u-button-primary u-submit kiwi-welcome-simple-start",innerHtml:"{start}",handler:function(e){e.preventDefault(),e.stopPropagation();this._connect_channel()}},{items:[{cls:"fn-sponsor",innerHtml:"{sponsor}"}]}]}]},{cls:"kiwi-startup-common-section kiwi-startup-common-section-info",items:[{cls:"kiwi-startup-common-section-info-content",innerHtml:"{startup}"}]}]}]}},IG$._wcollab=function(e){this._settings=e||{},e._container&&this._render(),e._container||(e._container=e._html);var i=$("#popup_error",e._container);$("#btn_close",i).bind("click",(function(){i.fadeOut()}))},IG$._wcollab.prototype={_render:function(){var e=this,i=e._settings,t=i._container,n=e._html={},s=window.location.href.split("/");i._embeded_html=!0,i.message=i.message||{start:"Start",nick:"Nick",startup:"<p>Welcome to your Data Analytics Cuddler.<br/><br/> <a href='http://www.amplixbi.com'>amplixbi</a> robo assist are here for help you.<br> To learn more about intelligent cuddler for your business, please visit <a href='https://amplixbi.com'>our website</a>.</p>",sponsor:"<span>Data Analytics Cuddler<br></span>Created by <a href='http://www.amplixbi.com/'>amplixbi.com</a>"},n.app_cuddle=$('<div id="app_cuddle"></div>').appendTo(t),n.loading=$(['<div id="loading" class="loading">','    <div class="loading_bg"></div>','    <div class="loading-msg"><img src="./images/ico_loading_circle.png" width="30" height="30" alt="" /></div>',"</div>"].join("")).appendTo(t),n.main_loading=$(['<div class="mainLoadingWrap" id="main_loading">','<div class="mainLoading">',"    <p>Calling agent to cuddle you.<br/>I am more then happy to serve you!<br/><span>Please wait a moment.</span></p>",'    <div class="progressWrap">','        <p class="line"></p>','        <img src="./images/ico_mainloading.png" width="18" height="14" alt="" />',"    </div>","</div>","</div>"].join("")).appendTo(t),n.popup_error=$(['<div id="popup_error" class="popupContainer">','<div class="popupWrap">','    <div class="popupContentWrap">','        <div class="popupImgWrap">','            <img src="./images/img_alert.png" width="80" height="80" alt="" />',"        </div>",'        <div id="msg_area" class="popupContent">','            <p id="msg_title" class="title"></p>','            <p id="msg_content"></p>',"        </div>",'        <div class="popupBtnWrap">','            <a id="btn_close" class="btn close">Close</a>',"        </div>","    </div>","</div>",'<div class="popupDimmed"></div>',"</div>"].join("")).appendTo(t),i.html=n.app_cuddle,e._init_setting();let a="";for(let e=3;e<s.length&&"launcher"!=s[e];e++)a+="/"+s[e];i.ws_path||(i.ws_path=a+"/websocket/collaborate"),i.request_url||(i.request_url=a+"/krcp");var o=n.popup_error;$("#btn_close",o).bind("click",(function(){o.fadeOut()}))},_init_setting:function(){var e=this._settings,i=window.location.href.split("/");e.protocol||(e.protocol="https:"==i[0]?"wss":"ws"),e.url||(e.url=i[2])},_init:function(){var e,i=this;e=i._settings,i._init_setting();var t,n=e.protocol+"://"+e.url+e.ws_path;i._userdetail=e.userdetail;try{(t=i.__ws=new WebSocket(n)).onopen=function(e){i.onopen(e)},t.onmessage=function(e){i.onmessage(e)},t.onclosed=function(e){i.onclosed(e)},t.onclosing=function(e){i.onclosing(e)}}catch(e){}},onopen:function(e){this._send_ws("_call_","login",{})},onmessage:function(e){var i,t=this,n=JSON.parse(e.data),s=t._settings,a={};if("_irc_"==n.application){switch(n.action){case"login":i="Logged in user <ul><li>"+n.content.name+" ("+n.content.id+")</li><li>"+n.content.email+"</li></ul>";break;case"writecontent":i="Content updated on server! <ul><li>"+n.content.nodepath+"</li></li>By: "+n.content.username+"</li></ul>";break;case"message":if($("#main_loading",s._container).fadeOut(),a=n.content,(i=a.message)&&i.startsWith("#ACT")&&s.instance){if(a.nlp_entities&&a.nlp_entities.length){var o=i;for(let e=0;e<a.nlp_entities.length;e++){let i=a.nlp_entities[e],t=i.entity,n=i.utteranceText||i.sourceText,s=o.indexOf("{"+t+"}");for(;s>-1;){let e=o.indexOf("}",s);s=(o=o.substring(0,s)+n+o.substring(e+1)).indexOf("{"+t+"}")}}a.before_message=i,a.message=o}return void s.instance.requestRoboAction.apply(s.instance,[t,a,function(e){a.orig_message=i,a.message=e.toString(),t._appendMsg(a)}])}if(i&&i.indexOf("@")>-1&&s.instance)return void s.instance.requestRoboFormat.apply(s.instance,[t,a,function(e){a.orig_message=i,a.message=e,t._appendMsg(a)}]);i||(a.message=IRm$.r1("ROBO_ERR_PROCESSING"))}t._appendMsg(a)}},_appendMsg:function(e){var i,t,n=this,s=n._settings,a=($("#messagecontainer",s._container),n.messagelist),o=n.messagelist_inner;function r(){n.theight=theight=o.height(),a.animate({scrollTop:theight},"slow");var t=$("a",i);$.each(t,(function(i,t){var a=$(t);a.bind("click",(function(i){i.preventDefault(),i.stopPropagation();var t=a.attr("amp_reply");t&&(t.startsWith("#ACT_")?s.instance.requestRoboAction.apply(s.instance,[n,{message:t,actor:{nick:"me",self:!0}},function(i){e.orig_message=e.message,e.message=i.toString()}]):n._send_ws("_call_","message",{message:t,actor:{nick:"me",self:!0}},!0),$("#ircinput",s._container).focus())}))}))}theight=n.theight||0,n._ttimer&&(clearTimeout(n._ttimer),n._ttimer=-1,n._ttimer_c&&(n._ttimer_c.html.html(n._ttimer_c.message.join(" ")),n._ttimer_c.html.trigger("animation_finished"),n._ttimer_c=null)),i=$("<div></div>").appendTo(o),t=n.draw_area(i,IG$._wcollab_data.msg_template,e,!e.actor.self),e.actor&&e.actor.self?t.addClass("igc_self_msg"):t.addClass("igc_bot_msg"),e.actor.self?r():t.bind("animation_finished",(function(e){r()}))},closeSession:function(){var e=this.__ws;e&&e.close(),this.__ws=null},_send_ws:function(e,i,t,n){var s,a=this,o=a.__ws,r=a._channel_info,c={application:e,action:i,instance:r.instance,channel:r.channel,id:a.guid(),content:t};if(s=c.content.message,n&&s&&s.indexOf(";")>0&&(c.content.message=s.substring(0,s.indexOf(";"))),1!==o.readyState&&0!==o.readyState)return a._appendMsg({actor:{},message:"Socket closed! Reconnect to bot"}),void a._init();if(o.send(JSON.stringify(c)),n&&s&&s.indexOf(";")>0&&(t.message=s.substring(s.indexOf(";")+1)),"message"===i)a._appendMsg(t)},load_app:function(){var e=this,i=e._settings,t=i.instance,n=i.html;e._loaded?$("#ircinput",i._container).focus():(e._loaded=!0,e.rootdiv=n,e.rootdiv.empty(),e._pages={},setTimeout((function(){if($("#main_loading",i._container).fadeOut(),i.html.fadeIn(),e._load_page("welcome_template"),t&&t.dlgLogin&&t.dlgLogin.logininfo){$("#txt_nick",i._container).val(t.dlgLogin.logininfo.username),$("#robo_form1",i._container).hide(),$("#robo_form2",i._container).hide(),setTimeout((function(){$("#robo_form2",i._container).trigger("click")}),800)}}),800))},_load_page:function(e){var i,t=this,n=t._settings;$.each(t._pages,(function(i,t){i==e?t.region.show():t.region.hide()})),t._pages[e]||(i=t.draw_area(t.rootdiv,IG$._wcollab_data[e],n.message),t._pages[e]={pname:e,region:i})},draw_area:function(e,i,t,n){return this._draw_sub(e,i,t,n)},setLoading:function(e){var i=this._settings;$("#loading",i._container)[e?"show":"fadeOut"]()},showErrorMessage:function(e,i){var t=this._settings,n=$("#popup_error",t._container);msg_title=$("#msg_title",n),msg_content=$("#msg_content",n),msg_title.html(e),msg_content.html(i),n.fadeIn()},_send_ajax:function(e,i){var t=this,n=t._settings;e.uniquekey=t._get_uniquekey(),window.Pace&&window.Pace.start(),t.setLoading(!0),$.ajax({url:n.request_url+"/"+e.ack,data:JSON.stringify(e),dataType:"json",type:"POST",async:!0,contentType:"application/json; charset=UTF-8",timeout:6e5,beforeSend:function(e,i){},cache:!1,crossDomain:!1,processData:!0,success:function(e,n,s){window.Pace&&window.Pace.stop();var a=(e=e||{errorcode:"0xffff",errormsg:"Server incorrect responding"}).errorcode;if(t.setLoading(!1),null!=a&&a.length>0){var o=!0;i&&(o=i.func.apply(i.scope||t,[e,!0])),!1!==o&&t.showErrorMessage("Error!",e.errormsg)}else i&&i.func.apply(i.scope||t,[e,!1])},error:function(e,i,n){window.Pace&&window.Pace.stop(),t.setLoading(!1);t.showErrorMessage("Error!","Server URL Connection Failed")}})},_get_uniquekey:function(){var e=new Date;return""+e.getFullYear()+(1+e.getMonth())+e.getDate()+e.getHours()+e.getMinutes()+e.getSeconds()},_draw_sub:function(e,i,t,n){var s,a,o,r=this,c=i.type||"div",l=["<"+c];if(i.cls&&l.push(" class='"+i.cls+"'"),i.name&&l.push(" name='"+i.name+"'"),i.id&&l.push(" id='"+i.id+"'"),i.attr&&$.each(i.attr,(function(e,i){l.push(" "+e+"='"+i+"'")})),l.push("></"+c+">"),l=$(l.join("")).appendTo(e),i.handler&&l.bind("click",(function(e){i.handler.apply(i.scope||r,[e])})),i.items)$.each(i.items,(function(e,i){r._draw_sub(l,i,t,n)}));else if(i.innerHtml)if(t&&"{"==i.innerHtml.charAt(0)&&"}"==i.innerHtml.charAt(i.innerHtml.length-1))if((s=i.innerHtml.substring(1,i.innerHtml.length-1)).indexOf(".")>-1){for(s=s.split("."),a=t,o=0;o<s.length;o++){if(!a[s[o]]){a=null;break}a=a[s[o]]}l.append(a||"")}else if("message"==s&&n)if(t[s].indexOf("<a")<0){let e=t[s].split(" "),i=0,n=5+Math.floor(50*Math.random()),a="";!function t(){if(i<e.length){let s=e[i];a+=" "+s,i++,l.html(a),i%40==0&&r.messagelist.animate({scrollTop:r.messagelist_inner.height()},"slow"),n=(" "==s||"."==s?60:5)+Math.floor(120*Math.random()),r._ttimer_c={html:l,message:e},r._ttimer=setTimeout(t,n)}else r._ttimer=-1}()}else l.append(t[s]||""),setTimeout((function(){l.trigger("animation_finished")}),10);else l.append(t[s]||"");else l.append(i.innerHtml);return l},_connect_channel:function(){var e=this,i=e._settings,t=$("#txt_nick",i._container);if(!t.val())return t.addClass("required_field"),void e.showErrorMessage("Field Input","Nick name is required!");t.removeClass("required_field"),e._send_ajax({ack:"collaborate",payload:{cmd:"request_channel"},mbody:e._settings.channel_name?{channel_name:"#"+e._settings.channel_name,nick:t.val()}:{nick:t.val()},_mts_:e._settings._mts_||IG$._g$a},{func:function(t,n){n||(e._channel_info=t.result,e._load_page("workspace_template"),e.messagelist=$("#messagelist",e._settings._container),e.messagelist_inner=$("#messagelist-inner",e.messagelist),e._init_ws(),e._init(),$("#ircinput",i._container).focus())}})},_init_ws:function(){var e=this,i=e._pages.workspace_template,t=$("#ircinput",i.region);e._msg_hist=e._msg_hist||[],e._msg_hist_back=e._msg_hist_back||0,t.keydown((function(i){13==i.which?(i.preventDefault(),i.stopPropagation(),e._send_msg()):38==i.which?e._msg_hist.length>e._msg_hist_back&&(e._msg_hist_back++,t.html(e._msg_hist[e._msg_hist.length-e._msg_hist_back])):40==i.which&&e._msg_hist_back>0&&e._msg_hist.length>e._msg_hist_back-1&&(e._msg_hist_back--,t.html(e._msg_hist[e._msg_hist.length-e._msg_hist_back]))})),$("#btn_send",i.region).bind("click",(function(i){i.preventDefault(),i.stopPropagation(),e._send_msg()}))},_send_msg:function(){var e=this,i=e._pages.workspace_template,t=$("#ircinput",i.region),n=t.html();n&&(t.empty(),e._msg_hist=e._msg_hist||[],e._msg_hist_back=0,e._msg_hist.push(n),e._send_ws("_call_","message",{message:n,actor:{nick:"me",self:!0}}))},guid:function(){var e,i;if(IG$._guid_lut)e=IG$._guid_lut;else for(e=IG$._guid_lut=[],i=0;i<256;i++)e[i]=(i<16?"0":"")+i.toString(16);var t=4294967295*Math.random()|0,n=4294967295*Math.random()|0,s=4294967295*Math.random()|0,a=4294967295*Math.random()|0;return e[255&t]+e[t>>8&255]+e[t>>16&255]+e[t>>24&255]+"-"+e[255&n]+e[n>>8&255]+"-"+e[n>>16&15|64]+e[n>>24&255]+"-"+e[63&s|128]+e[s>>8&255]+"-"+e[s>>16&255]+e[s>>24&255]+e[255&a]+e[a>>8&255]+e[a>>16&255]+e[a>>24&255]}};