function m$B2(t,a){var l=this;l.ind=t,l.rowdata=a,l.ellipses=[],l.label=$("<div class='bblabel'></div>"),l.html=$("<div class='bbbox'></div>"),l.ind.container.append(l.html),l.paper=new Raphael(l.html[0]),l.html.append(l.label),l.invalidate=-1,l.validateData.call(l)}function m$Bl(t){this.parent=t,this.mv=null,this.colorset=[.23,.4,.3],this.initVariables()}m$B2.prototype={validateData:function(){var t,a,l=this,e=l.ellipses,i=l.ind.colorset,n=l.rowdata;for(t=0;t<e.length;t++)e[t].html.remove();for(e=[],l.label.text(n.name),t=0;t<n.value.length;t++)(a={}).color=i[t%i.length],e.push(a);l.ellipses=e,l.validateDisplay()},validateDisplay:function(){var t=this;t.invalidate>-1&&clearTimeout(t.invalidate),setTimeout((function(){t.updateDisplay.call(t)}),100)},updateDisplay:function(){var t,a,l,e,i,n,h,o,s,r,m,c,p=this,u=p.ind,v=p.html,b=IG$.j$ext._w(v),d=IG$.j$ext._h(v),f=p.rowdata,x=p.ellipses,$=u.mcalc.max,g=null==u.mv?u.mcalc.min:u.mv>u.mcalc.min?u.mv:u.mcalc.min,y=p.label;if(b>0&&d>0){if((s=p.paper).clear(),s.setSize(b,d),x&&x.length>0){for(e=Math.min(b,d),a=$==g?$:$-g,o=0;o<x.length;o++)h=0==o?f.value[o]:h+f.value[o];for(n=(h-g)/a*(.8*e)+.1*e,o=0;o<x.length;o++)i=0==o?f.value[o]:i+f.value[o],l=Math.sqrt(n*n*i/h),(t=x[o]).x=b/2,t.y=d/2,t.radius=l/2;for(o=x.length-1;o>=0;o--)r=(t=x[o]).x,m=t.y,c=t.radius,hue=t.color,t.circle=s.set(s.ellipse(r,m+c-c/5,0,0).attr({fill:"rhsb("+hue+", 1, .25)-hsb("+hue+", 1, .25)",stroke:"none",opacity:0}).animate({rx:c,ry:c/2},400,"<"),s.ellipse(r,m,0,0).attr({fill:"r(.5,.9)hsb("+hue+", 1, .75)-hsb("+hue+", .5, .25)",stroke:"none"}).animate({rx:c,ry:c},400,"<"),s.ellipse(r,m,0,0).attr({stroke:"none",fill:"r(.5,.1)#ccc-#ccc",opacity:0}).animate({rx:c-c/5,ry:c-c/20},400,"<"))}p.label.css({top:d-y.height()-4,left:(b-IG$.j$ext._w(p.label))/2})}}},m$Bl.prototype={initVariables:function(){var t=this;t.ex=[],t.mx=[],t.bubbles=[],t.mcalc={},t.container=$("<div class='bbmain'></div>").appendTo(t.parent)},initControl:function(){var t,a=this.bubbles;for(t=0;t<a.length;t++)a[t].html.remove();a=[]},loadData:function(t){var a,l,e,i,n,h,o,s,r=this,m=r.ea,c=r.ma,p=r.mcalc;if(t&&t.length>0&&m&&m.length>0&&c&&c.length>0){for(a=0;a<c.length;a++)c[a].max=0,c[a].min=0;for(a=0;a<t.length;a++){for("col_"&a,i="",h=[],l=0;l<m.length;l++)e=m[l].i,i=0==l?t[a][e]:i+" "+t[a][e];for(l=0;l<c.length;l++)e=c[l].i,n=Number(t[a][e]),0==a?(c[l].min=n,c[l].max=n):(c[l].min=Math.min(c[l].min,n),c[l].max=Math.max(c[l].max,n)),o=0==l?n:o+n,h.push(n);0==a?(p.min=o,p.max=o):(p.min=Math.min(p.min,o),p.max=Math.max(p.max,o)),s=new m$B2(r,{name:i,value:h}),r.bubbles.push(s)}r.validateControl()}},validateControl:function(){var t,a,l,e,i,n=$(this.parent),h=IG$.j$ext._w(n),o=IG$.j$ext._h(n),s=this.bubbles;if(h>0&&o>0&&s&&s.length>0)for(i=0,l=h/s.length,e=o,a=0;a<s.length;a++)(t=s[a]).html.css({left:i,top:0,position:"absolute"}),IG$.j$ext._w(t.html,l),IG$.j$ext._h(t.html,e),t.validateDisplay.call(t),i+=l}};
IG$.m$CompMatrix=function(){this.xField=null,this.xFieldName=null,this.yField=null,this.yFieldName=null,this.compVal,this.dataSet=null,this.toString=function(){return this.xFieldName+", "+this.yFieldName+" : "+this.compVal}},IG$.compMatrixPlotCell=function(){var t,i,e=window.bowser,s=window&&window.SVGAngle||document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1");this.hasCanvas=!s&&!e.msie,this.compItem,this.xMin,this.xMax,this.yMin,this.yMax,this.xRange,this.yRange,this.cr1=0,this.cr2=0,this.selected,this.width,this.height,this.html=$('<div class="matrixchart"></div>'),1==this.hasCanvas&&(this.canvas=$("<canvas></canvas>"),this.canvas.appendTo(this.html)),this.updateExtremes=function(){if(this.compItem&&this.compItem.dataSet){for(this.xMin=Number.MAX_VALUE,this.yMin=Number.MAX_VALUE,this.xMax=Number.MIN_VALUE,this.yMax=Number.MIN_VALUE,t=0;t<this.compItem.dataSet.length;t++)i=this.compItem.dataSet[t],this.xMin=Math.min(this.xMin,i[this.compItem.xField]),this.yMin=Math.min(this.yMin,i[this.compItem.yField]),this.xMax=Math.max(this.xMax,i[this.compItem.xField]),this.yMax=Math.max(this.yMax,i[this.compItem.yField]);this.xRange=this.xMax-this.xMin,this.yRange=this.yMax-this.yMin}},this.computeX=function(t){var i=t[this.compItem.xField];return 1-(this.xMax-i)/this.xRange},this.computeY=function(t){var i=t[this.compItem.yField];return 1-(this.yMax-i)/this.yRange},this.updatePlot=function(){var t,i,e,s;for(this.plotData=[],t=0;t<this.compItem.dataSet.length;t++)i=this.compItem.dataSet[t],e=this.computeX(i),s=this.computeY(i),this.plotData.push([e,s]);this.drawPlot()},this.drawPlot=function(){this.width=this.html.innerWidth(),this.height=this.html.innerHeight();var i,e={};for(i=this.compItem.compVal>this.cr2?"rgba(0,0,255,":this.compItem.compVal>this.cr1?"rgba(150,150,150,":"rgba(255,0,0,",1==this.hasCanvas?(this.canvas.width=this.width,this.canvas.height=this.height,this.ctx=this.canvas[0].getContext("2d"),this.ctx.scale(1,1),this.ctx.fillStyle="rgb(255,255,255)",this.ctx.fillRect(0,0,this.width,this.height),this.ctx.strokeStyle="#5F5F5F",this.ctx.lineWidth=1,this.ctx.fillStyle=i+".5)"):this.paper?this.paper.clear():this.paper=Raphael(this.html[0],0,0,this.width,this.height),t=0;t<this.plotData.length;t++){var s,h=this.plotData[t],a=0==isNaN(h[0])?h[0]*this.width:0,l=0==isNaN(h[1])?(1-h[1])*this.height:this.height,o=Math.floor(a),n=Math.floor(l);e[s=(o-=o%5)+","+(n-=n%5)]||(1==this.hasCanvas?(this.ctx.beginPath(),this.ctx.arc(a,l,1,0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.fill(),e[s]={obj:!0,mbody:0}):(e[s]={obj:this.paper.circle(a,l,2),mbody:0},e[s].obj.attr("fill",i+"0.5)")))}e=null},this.updateDispList=function(t,i){this.drawPlot()},this.commitProps=function(){this.updateExtremes(),this.updatePlot()}},IG$.ComparisonMatrix=function(t,i){this.compItems=null,this.cells=[],this.parent=t,this.config=i,this.textFields=[],this.showLabels=i.showLabels||!0,this.cr1=null==i.cr1||void 0===i.cr1?0:i.cr1,this.cr2=null==i.cr2||void 0===i.cr2?0:i.cr2,this.container=$('<div class="matrixcontainer"></div>'),this.container.appendTo(this.parent),this.labelhtml=$('<div class="matrixlabel"></div>'),this.labelhtml.css({position:"absolute",top:"0px",left:"0px",width:"0px",height:"0px"}),this.labelhtml.appendTo(this.parent),this.isDirty=!1,this.detailviewer=$('<div class="detailviewer"></div>'),this.detailviewer.css({position:"absolute",top:10,left:10,width:100,height:100,margin:0,padding:0,backgroundColor:"#ececec",borderColor:"#222222",display:"none"}),this.detailviewer.appendTo(this.parent),this.detailviewer.bind("click",(function(){$(this).fadeOut()})),this.detailcontainer=$('<div class="detailmatrixplot"></div>'),this.detailcontainer.css({position:"absolute",margin:"20 0 0 0",padding:0,top:0,left:0,right:0,bottom:0}),this.uid=0,this.detailcontainer.appendTo(this.detailviewer);var e=$('<div class="detailmatrixclosebtn"></div>'),s=this.detailviewer;e.css({position:"absolute",top:2,width:16,height:16,right:2}),this.detailviewer.append(e),e.bind({click:function(){s.fadeOut()}}),this.correlationCoefficient=function(t,i,e){var s,h,a=t.length,l=0,o=0,n=0,r=0,c=0;for(h=0;h<t.length;h++){var d=(s=t[h])[i],m=s[e];l+=d,o+=m,n+=Math.pow(d,2),r+=Math.pow(m,2),c+=d*m}return(a*c-l*o)/(Math.sqrt(a*n-Math.pow(l,2))*Math.sqrt(a*r-Math.pow(o,2)))},this.comparisonFunction=this.correlationCoefficient,this.generateComparisonStatistics=function(){if(this.compItems=[],0!=this.fields.length&&null!=this.dataSet&&0!=this.dataSet.length)for(var t=this.fields.length,i=0;i<t;i++)for(var e=0;e<i+1;e++)if(i!=e){var s=new IG$.m$CompMatrix;s.xFieldName=this.fields[i],s.xField=i,s.yFieldName=this.fields[e],s.yField=e,s.compVal=this.comparisonFunction.call(this,this.dataSet,s.xField,s.yField),this.compItems.push(s)}},this.createOrRemoveCells=function(){var t,i=this,e=this.compItems.length;for(this.matrixitems={};this.cells.length<e;){var s=new IG$.compMatrixPlotCell;s.html.css({border:"1px solid #a5a5a5",width:200,height:200,position:"absolute",padding:0}),s.html.appendTo(this.container),t="matrixplot"+this.uid,s.html[0].id=t,this.uid++,s.html.bind({click:function(){i.drawDetailPlot.call(i,this)}}),this.cells.push(s),this.matrixitems[t]=s}for(;e<this.cells.length;){this.cells.pop().remove()}},this.updateTextFields=function(){var t,i,e=this.fields.length;for(t=0;t<e;t++)this.textFields.length<t+1&&((i=$('<div class="matrixtextfield"></div>')).css({fontSize:"0.8em",padding:"0 0 0 3",margin:0,position:"absolute",width:130}),this.textFields.push(i),i.appendTo(this.labelhtml)),this.textFields[t][0].innerText=this.fields[t];for(;e<this.textFields.length;){textFields.pop();this.textFieldToRemove.remove()}},this.layoutTextFields=function(){var t,i,e,s,h,a=this.textFields.length;if(a>0)for(t=this.textFields[0].height(),i=0;i<a;i++)e=this.textFields[i],s=i*this.actualCellSize+1,h=0==i?0:(i-1)*this.actualCellSize+t,e.css({left:s,top:h})},this.layoutCells=function(){var t=0;if(this.showLabels&&this.textFields.length>0){var i=this.textFields[0];t=i.position().top+i.height()}for(var e=this.fields.length,s=0,h=0;h<e;h++)for(var a=0;a<h+1;a++)if(h!=a){var l=this.compItems[s],o=this.cells[s];l.dataSet=this.dataSet,o.compItem=l,o.selected=l==this.selectedItem;var n;n=l.xField+"\n"+l.yField+"\n"+l.compVal,o.toolTip=n;var r=a*this.actualCellSize,c=(h-1)*this.actualCellSize+t;o.html.css({left:r,top:c,width:this.actualCellSize,height:this.actualCellSize}),o.cr1=this.cr1,o.cr2=this.cr2,1==this.isDirty?o.commitProps.call(o):o.updateDispList.call(o),s++}},this.computeCellSize=function(t,i){var e=t,s=i;return 1==this.showLabels&&this.textFields.length>0?(e=t-this.textFields[this.textFields.length-1].width(),s=i-this.textFields[0].height()):(e=t,s=i),Math.min(e,s)/(this.fields.length-1)},this.updateDispList=function(){var t=$(this.parent),i=t.innerWidth(),e=t.innerHeight();this.container.css({width:i,height:e}),this.actualCellSize=this.computeCellSize(i,e),this.showLabels&&this.textFields.length>0&&this.layoutTextFields(),this.layoutCells()},this.commitProp=function(){this.isDirty=!0,this.generateComparisonStatistics(),this.createOrRemoveCells(),this.updateTextFields(),this.updateDispList(),this.isDirty=!1}},IG$.ComparisonMatrix.prototype.drawDetailPlot=function(t){var i=this.matrixitems[t.id],e=i.compItem.compVal>this.cr2?"rgba(0,0,255,.5)":i.compItem.compVal>this.cr1?"rgba(150,150,150,.5)":"rgba(255,0,0,0.5)";if(i){var s={chart:{renderTo:this.detailcontainer[0],defaultSeriesType:"scatter",zoomType:"xy"},title:{text:i.compItem.xFieldName+" vs. "+i.compItem.yFieldName},xAxis:{title:{enabled:!0,text:i.compItem.xFieldName},startOnTick:!0,endOnTick:!0,showLastLabel:!0,min:0,max:1},yAxis:{title:{text:i.compItem.yFieldName},min:0,max:1},tooltip:{formatter:function(){return this.x+", "+this.y}},legend:{enabled:!1,layout:"vertical",align:"left",verticalAlign:"top",floating:!0,backgroundColor:"#FFFFFF",borderWidth:1},plotOptions:{scatter:{marker:{radius:5,states:{hover:{enabled:!0,lineColor:"rgb(100,100,100)"}}},states:{hover:{marker:{enabled:!1}}}}},series:[{name:"comparison",color:e,data:i.plotData}]},h=$(this.parent),a=h.width(),l=h.height(),o=.85*Math.min(l,a);this.detailviewer.css({left:a-o-10,top:5,width:o,height:o}),this.detailviewer.show(),this.plotdetail=new Highcharts.Chart(s)}};
IG$.c$NatChart=function(t,a,n){this.owner=t,this.sheetoption=a,this.cop=n,this.initialize()},IG$.c$NatChart.prototype={initialize:function(){var t=this.owner;$("<div></div>").appendTo(t);this.margin={top:19.5,right:19.5,bottom:19.5,left:39.5},this.width=IG$.j$ext._w(t),this.height=IG$.j$ext._h(t)},loadData:function(t){var a,n,e,r,o,i,d,s,l=this,c=(l.owner,l.width,l.height,l.margin,$("<div><div>").appendTo(l.owner),l.bb,t._tabledata),u=t.colfix,f=t.rowfix,m=c.length>0?c[0].length:0,h=[],p={},b=u-1,g=b-1>-1?b-1:b,x=g-1>-1?g-1:g,v=u,w=m>u+1?u+1:v,M=m>v+1?v+1:v,y={},N=0,C=[],_=[{m:0,M:0},{m:0,M:0},{m:0,M:0}];if(x=(d=l.findCols(l.cop.nat_timefield,u))>-1?d:x,b=(d=l.findCols(l.cop.nat_datafield,u))>-1?d:b,g=(d=l.findCols(l.cop.nat_groupfield,u))>-1?d:g,v=(d=l.findCols(l.cop.nat_xdata,u))>-1?d:v,w=(d=l.findCols(l.cop.nat_ydata,u))>-1?d:w,M=(d=l.findCols(l.cop.nat_vdata,u))>-1?d:M,u>0){for(n=f;n<c.length;n++)y[i=c[n][x].text||c[n][x].code||""]||(C.push(i),y[i]=1);for(N=C.length,C=C.sort(),y={},n=0;n<C.length;n++)y[C[n]]=n;for(n=f;n<c.length;n++){if(p[a=c[n][b].text||c[n][b].code])r=p[a];else{for(r={name:c[n][b].text||c[n][b].code,region:c[n][g].text||c[n][g].code,bbdata1:[],bbdata2:[],bbdata3:[]},e=0;e<C.length;e++)r.bbdata1.push([e,0]),r.bbdata2.push([e,0]),r.bbdata3.push([e,0]);p[a]=r,h.push(r)}o=-1,void 0!==y[i=c[n][x].text||c[n][x].code||""]&&(o=y[i]),s=Number(c[n][v].code)||0,s=isNaN(s)?0:s,r.bbdata1[o][1]=s,_[0].m=Math.min(s,_[0].m),_[0].M=Math.max(s,_[0].M),s=Number(c[n][w].code)||0,s=isNaN(s)?0:s,r.bbdata2[o][1]=s,_[1].m=Math.min(s,_[1].m),_[1].M=Math.max(s,_[1].M),s=Number(c[n][M].code)||0,s=isNaN(s)?0:s,r.bbdata3[o][1]=s,_[2].m=Math.min(s,_[2].m),_[2].M=Math.max(s,_[2].M)}}if(_)for(n=0;n<_.length;n++)_[n].m==_[n].M&&(_[n].M=_[n].m+10);l.segnames=y,l.seglists=C,l.segmax=N,l.fs=_,l.dt=h,l.drawChart()},drawChart:function(){var t,a=this,n=(a.owner,a.dt),e=a.fs;function r(t){return t.bbdata1}function o(t){return t.bbdata2}function i(t){return t.bbdata3}function d(t){return t.name}a.owner.empty(),t=$("<div><div>").appendTo(a.owner);var s,l=a.margin,c=IG$.j$ext._w(a.owner)-l.right-l.left,u=IG$.j$ext._h(a.owner)-l.top-l.bottom,f=d3.scale.linear().domain([e[0].m,e[0].M]).range([0,c]),m=d3.scale.linear().domain([e[1].m,e[1].M]).range([u,0]),h=d3.scale.sqrt().domain([e[2].m,e[2].M]).range([0,40]),p=d3.scale.category10(),b=d3.svg.axis().orient("bottom").scale(f).ticks(12,d3.format(",d")),g=d3.svg.axis().scale(m).orient("left");(s=this.vis=d3.select(t[0]).append("svg").attr("width",c+l.left+l.right).attr("height",u+l.top+l.bottom).append("g").attr("transform","translate("+l.left+","+l.top+")")).append("g").attr("class","d3-nation-x d3-nation-axis").attr("transform","translate(0,"+u+")").call(b),s.append("g").attr("class","d3-nation-y d3-nation-axis").call(g),s.append("text").attr("class","d3-nation-x d3-nation-label").attr("text-anchor","end").attr("x",c).attr("y",u-6),s.append("text").attr("class","d3-nation-y d3-nation-label").attr("text-anchor","end").attr("y",6).attr("dy",".75em").attr("transform","rotate(-90)");var x,v,w=s.append("text").attr("class","d3-nation-year d3-nation-label").attr("text-anchor","end").attr("y",u-24).attr("x",c),M=d3.bisector((function(t){return t[0]})),y=s.append("g").attr("class","d3-nation-dots").selectAll(".dot").data(I(0)).enter();function N(t){t.attr("cx",(function(t){var a=f(r(t));return a=a<0?0:a})).attr("cy",(function(t){var a=m(o(t));return a=a<0?0:a})).attr("r",(function(t){var a=h(i(t));return a=a<0?0:a}))}function C(t){t.attr("x",(function(t){var a,n=f(r(t));return(n=n<0?0:n)-(a=(a=h(i(t)))<0?0:a)})).attr("y",(function(t){var a=m(o(t));return a=a<0?0:a}))}function _(t,a){return i(a)-i(t)}function G(t){v.data(I(t),d).call(N).sort(_),x.data(I(t),d).call(C).sort(_),w.text(a.seglists[Math.floor(t)])}function I(t){return n.map((function(a){return{name:a.name,region:a.region,bbdata1:j(a.bbdata1,t),bbdata2:j(a.bbdata2,t),bbdata3:j(a.bbdata3,t)}}))}function j(t,a){var n=M.left(t,a,0,t.length-1),e=t[n];if(n>0){var r=t[n-1],o=(a-e[0])/(r[0]-e[0]);return e[1]*(1-o)+r[1]*o}return e[1]}(v=y.append("circle").attr("class","d3-nation-dot").style("fill",(function(t){return p(function(t){return t.region}(t))})).call(N).sort(_)).append("title").text((function(t){return t.name})),x=y.append("text").text((function(t){return t.name})).call(C),s.transition().duration(800*a.segmax).ease("linear").tween("year",(function(){var t=d3.interpolateNumber(0,a.segmax-1);return function(a){G(t(a))}})).each("end",(function(){var t=w.node().getBBox(),n=d3.scale.linear().domain([0,a.segmax]).range([t.x+10,t.x+t.width-10]).clamp(!0);function e(){G(n.invert(d3.mouse(this)[0]))}s.append("rect").attr("class","d3-nation-overlay").attr("x",t.x).attr("y",t.y).attr("width",t.width).attr("height",t.height).on("mouseover",(function(){w.classed("active",!0)})).on("mouseout",(function(){w.classed("active",!1)})).on("mousemove",e).on("touchmove",e)}))},findCols:function(t,a){var n,e=this.sheetoption,r=-1;for(n=0;n<e.model.rows.length;n++)if(e.model.rows[n].name==t){r=n;break}if(-1==r&&e.model.measures.length>0)for(n=0;n<e.model.measures.length;n++)if(e.model.measures[n].name==t){r=n+a;break}return r}};
window.d3&&(d3.sankey=function(){var n,t={},r=24,u=8,o=[1,1],e=[],c=[];function i(){function n(n,t){return n.source.y-t.source.y}function t(n,t){return n.target.y-t.target.y}e.forEach((function(r){r.sourceLinks.sort(t),r.targetLinks.sort(n)})),e.forEach((function(n){var t=0,r=0;n.sourceLinks.forEach((function(n){n.sy=t,t+=n.dy})),n.targetLinks.forEach((function(n){n.ty=r,r+=n.dy}))}))}function f(n){return n.y+n.dy/2}function a(n){return n.value}return t.nodeWidth=function(n){return arguments.length?(r=+n,t):r},t.nodePadding=function(n){return arguments.length?(u=+n,t):u},t.nodes=function(n){return arguments.length?(e=n,t):e},t.links=function(n){return arguments.length?(c=n,t):c},t.size=function(r){return arguments.length?(o=r,n=r[0],t):o},t.layout=function(s){return e.forEach((function(n){n.sourceLinks=[],n.targetLinks=[]})),c.forEach((function(n){var t=n.source,r=n.target;"number"==typeof t&&(t=n.source=e[n.source]),"number"==typeof r&&(r=n.target=e[n.target]),t.sourceLinks.push(n),r.targetLinks.push(n)})),e.forEach((function(n){n.value=Math.max(d3.sum(n.sourceLinks,a),d3.sum(n.targetLinks,a))})),function(){var t,u=e,o=0;for(;u.length;)t=[],u.forEach((function(n){n.x=o,n.dx=r,n.sourceLinks.forEach((function(n){t.push(n.target)}))})),u=t,++o;(function(n){e.forEach((function(t){t.sourceLinks.length||(t.x=n-1)}))})(o),c=(n-r)/(o-1),e.forEach((function(n){n.x*=c}));var c}(),function(n){var t=d3.nest().key((function(n){return n.x})).sortKeys(d3.ascending).entries(e).map((function(n){return n.values}));r=d3.min(t,(function(n){return(o[1]-(n.length-1)*u)/d3.sum(n,a)})),t.forEach((function(n){n.forEach((function(n,t){n.y=t,n.dy=n.value*r}))})),c.forEach((function(n){n.dy=n.value*r})),h();var r;for(var i=1;n>0;--n)y(i*=.99),h(),s(i),h();function s(n){function r(n){return f(n.source)*n.value}t.forEach((function(t,u){t.forEach((function(t){if(t.targetLinks.length){var u=d3.sum(t.targetLinks,r)/d3.sum(t.targetLinks,a);t.y+=(u-f(t))*n}}))}))}function y(n){function r(n){return f(n.target)*n.value}t.slice().reverse().forEach((function(t){t.forEach((function(t){if(t.sourceLinks.length){var u=d3.sum(t.sourceLinks,r)/d3.sum(t.sourceLinks,a);t.y+=(u-f(t))*n}}))}))}function h(){t.forEach((function(n){var t,r,e,c=0,i=n.length;for(n.sort(d),e=0;e<i;++e)(r=c-(t=n[e]).y)>0&&(t.y+=r),c=t.y+t.dy+u;if((r=c-u-o[1])>0)for(c=t.y-=r,e=i-2;e>=0;--e)(r=(t=n[e]).y+t.dy+u-c)>0&&(t.y-=r),c=t.y}))}function d(n,t){return n.y-t.y}}(s),i(),t},t.relayout=function(){return i(),t},t.link=function(){var n=.5;function t(t){var r=t.source.x+t.source.dx,u=t.target.x,o=d3.interpolateNumber(r,u),e=o(n),c=o(1-n),i=t.source.y+t.sy+t.dy/2,f=t.target.y+t.ty+t.dy/2;return"M"+r+","+i+"C"+e+","+i+" "+c+","+f+" "+u+","+f}return t.curvature=function(r){return arguments.length?(n=+r,t):n},t},t});
IG$.v$Sankey=function(t){this.owner=t,this.bb=null,this.initialize()},IG$.v$Sankey.prototype={initialize:function(){var t,e=this,n=e.owner,a=$("<div></div>").appendTo(n);e.width=IG$.j$ext._w(n),e.height=IG$.j$ext._h(n),e.margin={top:1,right:1,bottom:6,left:1},this.bb||(this.bb=IG$.c$BullChartV(),IG$.j$ext._w(this.bb,e.width-e.margin.right-e.margin.left),IG$.j$ext._h(this.bb,e.height-e.margin.top-e.margin.bottom)),t=$("<ul></ul>").appendTo(a),e.gtp=t,t=$("<li></li>").appendTo(e.gtp),$("<div>Ranges</div>").appendTo(t),e.ranges=$("<combobox></combobox>").appendTo(t),t=$("<li></li>").appendTo(e.gtp),$("<div>Measures</div>").appendTo(t),e.measures=$("<combobox></combobox>").appendTo(t),t=$("<li></li>").appendTo(e.gtp),$("<div>Markers</div>").appendTo(t),e.markers=$("<combobox></combobox>").appendTo(t)},loadData:function(t){var e,n,a,r=this,o=(r.owner,r.width),i=r.height,d=r.margin,l=$("<div><div>").appendTo(r.owner);d3.select(l[0]).append("svg").attr("width",o+d.left+d.right).attr("height",i+d.top+d.bottom).append("g").attr("transform","translate("+d.left+","+d.top+")");e={nodes:[],lines:[]};var s,p,h,u,c=t._tabledata,g=t.colfix,f=t.rowfix,m=(c.length>0&&c[0].length,0+g),b={};for(n=0;n<g;n++)mapinfo.push({});for(n=f;n<c.length;n++)for(a=0;a<g;a++)b[s=c[n][a].code]||(h=e.nodes.length,b[s]=h,e.nodes.push(s));for(n=f;n<c.length;n++)for(a=0;a<g;a++)s=c[n][a].code,a+1<g&&(p=c[n][a+1].code,u={source:b[s],target:b[p],value:Number(c[n][m].code)},e.lines.push(u));r.drawChart(e)},drawChart:function(t){var e=d3.format(",.0f"),n=function(t){return e(t)+" TWh"},a=d3.scale.category20(),r=d3.sankey().nodeWidth(15).nodePadding(10).size([width,height]),o=r.link();r.nodes(t.nodes).links(t.links).layout(32);var i=svg.append("g").selectAll(".link").data(t.links).enter().append("path").attr("class","link").attr("d",o).style("stroke-width",(function(t){return Math.max(1,t.dy)})).sort((function(t,e){return e.dy-t.dy}));i.append("title").text((function(t){return t.source.name+" �� "+t.target.name+"\n"+n(t.value)}));var d=svg.append("g").selectAll(".node").data(t.nodes).enter().append("g").attr("class","node").attr("transform",(function(t){return"translate("+t.x+","+t.y+")"})).call(d3.behavior.drag().origin((function(t){return t})).on("dragstart",(function(){this.parentNode.appendChild(this)})).on("drag",(function(t){d3.select(this).attr("transform","translate("+t.x+","+(t.y=Math.max(0,Math.min(height-t.dy,d3.event.y)))+")"),r.relayout(),i.attr("d",o)})));d.append("rect").attr("height",(function(t){return t.dy})).attr("width",r.nodeWidth()).style("fill",(function(t){return t.color=a(t.name.replace(/ .*/,""))})).style("stroke",(function(t){return d3.rgb(t.color).darker(2)})).append("title").text((function(t){return t.name+"\n"+n(t.value)})),d.append("text").attr("x",-6).attr("y",(function(t){return t.dy/2})).attr("dy",".35em").attr("text-anchor","end").attr("transform",null).text((function(t){return t.name})).filter((function(t){return t.x<width/2})).attr("x",6+r.nodeWidth()).attr("text-anchor","start")}};
function randomize(t){return t.randomizer||(t.randomizer=randomizer(t)),t.ranges=t.ranges.map(t.randomizer),t.markers=t.markers.map(t.randomizer),t.measures=t.measures.map(t.randomizer),t}function randomizer(t){var r=.2*d3.max(t.ranges);return function(t){return Math.max(0,t+r*(Math.random()-.5))}}function bulletRanges(t){return t.ranges}function bulletMarkers(t){return t.markers}function bulletMeasures(t){return t.measures}function bulletTranslate(t){return function(r){return"translate("+t(r)+",0)"}}function bulletWidth(t){var r=t(0);return function(a){return Math.abs(t(a)-r)}}IG$.c$BulChart=function(t){this.owner=t,this.bb=null,this.initialize()},IG$.c$BulChart.prototype={initialize:function(){var t,r=this,a=r.owner,e=$("<div></div>").appendTo(a);r.width=IG$.j$ext._w(a),r.height=IG$.j$ext._h(a),r.margin={top:5,right:40,bottom:20,left:120},r.bb||(r.bb=IG$.c$BullChartV(),IG$.j$ext._w(r.bb,r.width-r.margin.right-r.margin.left),IG$.j$ext._h(r.bb,r.height-r.margin.top-r.margin.bottom)),t=$("<ul></ul>").appendTo(e),r.gtp=t,t=$("<li></li>").appendTo(r.gtp),$("<div>Ranges</div>").appendTo(t),r.ranges=$("<combobox></combobox>").appendTo(t),t=$("<li></li>").appendTo(r.gtp),$("<div>Measures</div>").appendTo(t),r.measures=$("<combobox></combobox>").appendTo(t),t=$("<li></li>").appendTo(r.gtp),$("<div>Markers</div>").appendTo(t),r.markers=$("<combobox></combobox>").appendTo(t)},loadData:function(t){var r,a=this,e=(a.owner,a.width),n=a.height,i=a.margin,l=$("<div><div>").appendTo(a.owner),o=d3.select(l[0]).selectAll("svg"),s=a.bb;r=a.getData(),o.data(r).enter().append("svg").attr("class","bullet").attr("width",e).attr("height",n).append("g").attr("transform","translate("+i.left+","+i.top+")").call(s);var u=o.append("g").attr("text-anchor","end").attr("transform","translate(-6,"+(n-i.top-i.bottom)/2+")");u.append("text").attr("class","title").text((function(t){return t.title})),u.append("text").attr("class","subtitle").attr("dy","1em").text((function(t){return t.subtitle})),a.vis=o,a.title=u,s.duration(1e3)},drawChart:function(){var t=this.bb;vis.datum(randomize).call(t)},getData:function(){var t,r,a,e,n,i,l,o,s=[],u=mresult._tabledata,d=mresult.colfix,c=mresult.rowfix,h=u.length>0?u[0].length:0,m={},g={};for(t=d;t<h;t++);for(t=c;t<u.length;t++){for(a={title:null,ranges:[],measures:[],markers:[]},l=null,o=null,r=0;r<h;r++)r<d?(e=u[t][r].text||u[t][r].code,a.title=0==t?e:a.title+" "+e):(e=Number(u[t][r].code),n=r==d?e:Math.max(n,e),i=r==d?e:Math.min(i,e),1==m[r]&&(null==l?(l=e,o=e):(l=Math.min(l,e),o=Math.max(o,e))),1==g[r]&&a.markers.push(e));a.ranges=[i,void 0,n],a.measures=[l,o],s.push(a)}return s}},IG$.c$BullChartV=function(){var t="left",r=!1,a=0,e=bulletRanges,n=bulletMarkers,i=bulletMeasures,l=380,o=30,s=null;function u(t){t.each((function(t,u){var d=e.call(this,t,u).slice().sort(d3.descending),c=n.call(this,t,u).slice().sort(d3.descending),h=i.call(this,t,u).slice().sort(d3.descending),m=d3.select(this),g=d3.scale.linear().domain([0,Math.max(d[0],c[0],h[0])]).range(r?[l,0]:[0,l]),p=this.__chart__||d3.scale.linear().domain([0,1/0]).range(g.range());this.__chart__=g;var b=bulletWidth(p),f=bulletWidth(g),x=m.selectAll("rect.range").data(d);x.enter().append("svg:rect").attr("class",(function(t,r){return"range s"+r})).attr("width",b).attr("height",o).attr("x",r?p:0).transition().duration(a).attr("width",f).attr("x",r?g:0),x.transition().duration(a).attr("x",r?g:0).attr("width",f).attr("height",o);var v=m.selectAll("rect.measure").data(h);v.enter().append("svg:rect").attr("class",(function(t,r){return"measure s"+r})).attr("width",b).attr("height",o/3).attr("x",r?p:0).attr("y",o/3).transition().duration(a).attr("width",f).attr("x",r?g:0),v.transition().duration(a).attr("width",f).attr("height",o/3).attr("x",r?g:0).attr("y",o/3);var $=m.selectAll("line.marker").data(c);$.enter().append("svg:line").attr("class","marker").attr("x1",p).attr("x2",p).attr("y1",o/6).attr("y2",5*o/6).transition().duration(a).attr("x1",g).attr("x2",g),$.transition().duration(a).attr("x1",g).attr("x2",g).attr("y1",o/6).attr("y2",5*o/6);var y=s||g.tickFormat(8),w=m.selectAll("g.tick").data(g.ticks(8),(function(t){return this.textContent||y(t)})),k=w.enter().append("svg:g").attr("class","tick").attr("transform",bulletTranslate(p)).style("opacity",1e-6);k.append("svg:line").attr("y1",o).attr("y2",7*o/6),k.append("svg:text").attr("text-anchor","middle").attr("dy","1em").attr("y",7*o/6).text(y),k.transition().duration(a).attr("transform",bulletTranslate(g)).style("opacity",1);var T=w.transition().duration(a).attr("transform",bulletTranslate(g)).style("opacity",1);T.select("line").attr("y1",o).attr("y2",7*o/6),T.select("text").attr("y",7*o/6),w.exit().transition().duration(a).attr("transform",bulletTranslate(g)).style("opacity",1e-6).remove()})),d3.timer.flush()}return u.orient=function(a){return arguments.length?(r="right"==(t=a)||"bottom"==t,u):t},u.ranges=function(t){return arguments.length?(e=t,u):e},u.markers=function(t){return arguments.length?(n=t,u):n},u.measures=function(t){return arguments.length?(i=t,u):i},u.width=function(t){return arguments.length?(l=t,u):l},u.height=function(t){return arguments.length?(o=t,u):o},u.tickFormat=function(t){return arguments.length?(s=t,u):s},u.duration=function(t){return arguments.length?(a=t,u):a},u};